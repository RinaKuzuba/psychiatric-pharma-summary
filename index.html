<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–¬å‰¤ç®¡ç†ã‚µãƒãƒªãƒ¼è‡ªå‹•ä½œæˆã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700;900&family=Bebas+Neue&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #5B2C6F;
            --secondary: #E74C3C;
            --accent: #F39C12;
            --dark: #17202A;
            --light: #FDFEFE;
            --gray: #95A5A6;
            --success: #27AE60;
            --warning: #F1C40F;
            --danger: #E74C3C;
            --gradient-1: linear-gradient(135deg, #5B2C6F 0%, #8E44AD 50%, #E74C3C 100%);
            --gradient-2: linear-gradient(135deg, #1A5276 0%, #2980B9 50%, #5DADE2 100%);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.16);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.20);
            --radius: 16px;
            --radius-sm: 8px;
            --radius-lg: 24px;
        }

        body {
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1A1A2E 0%, #16213E 50%, #0F3460 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(91, 44, 111, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(231, 76, 60, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(52, 152, 219, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: var(--radius-lg);
            box-shadow: 
                0 0 0 1px rgba(255, 255, 255, 0.1),
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 40px 120px rgba(91, 44, 111, 0.3);
            overflow: hidden;
            animation: slideInScale 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            z-index: 10;
            backdrop-filter: blur(20px);
        }

        @keyframes slideInScale {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .header {
            background: var(--gradient-1);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .header h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px;
            margin-bottom: 10px;
            letter-spacing: 2px;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header .emoji {
            font-size: 48px;
            display: inline-block;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .security-notice {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 25px;
            font-size: 14px;
            position: relative;
            z-index: 1;
            animation: fadeInUp 0.8s ease-out 0.3s both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-container {
            padding: 25px 40px;
            background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
            border-bottom: 1px solid #DEE2E6;
            position: relative;
        }

        .progress-bar {
            background: #E9ECEF;
            height: 10px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            background: var(--gradient-1);
            height: 100%;
            border-radius: 20px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            margin-top: 15px;
            font-size: 14px;
            color: var(--gray);
            display: flex;
            justify-content: space-between;
            font-weight: 500;
        }

        .timer-container {
            padding: 15px 40px;
            background: linear-gradient(135deg, #FFF3CD 0%, #FFE9A0 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #FFC107;
        }

        .timer-bar {
            flex: 1;
            background: rgba(255, 255, 255, 0.5);
            height: 8px;
            border-radius: 20px;
            margin-left: 20px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .timer-fill {
            background: linear-gradient(90deg, #FF6B6B, #FFC107);
            height: 100%;
            border-radius: 20px;
            transition: width 1s linear;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
        }

        .timer-text {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            font-weight: bold;
            color: #856404;
            min-width: 50px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .question-container {
            padding: 50px;
            min-height: 450px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: 
                radial-gradient(ellipse at top left, rgba(91, 44, 111, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(52, 152, 219, 0.05) 0%, transparent 50%);
        }

        .question-category {
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0;
            animation: fadeInLeft 0.5s ease-out forwards;
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .question-text {
            font-size: 28px;
            color: var(--dark);
            margin-bottom: 35px;
            line-height: 1.6;
            font-weight: 600;
            opacity: 0;
            animation: fadeInUp 0.5s ease-out 0.1s forwards;
        }

        .change-indicator {
            display: inline-block;
            background: var(--warning);
            color: var(--dark);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .input-container {
            margin-top: 25px;
            opacity: 0;
            animation: fadeInUp 0.5s ease-out 0.2s forwards;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 18px;
            border: 2px solid #E9ECEF;
            border-radius: var(--radius-sm);
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
            font-family: 'Noto Sans JP', sans-serif;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(91, 44, 111, 0.1);
            transform: translateY(-2px);
        }

        textarea {
            min-height: 140px;
            resize: vertical;
            font-family: inherit;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #F8F9FA 0%, #FFFFFF 100%);
            border: 2px solid #E9ECEF;
            border-radius: var(--radius-sm);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .checkbox-item:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, #FFFFFF 0%, #F3E5F5 100%);
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 12px;
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .checkbox-item label {
            cursor: pointer;
            flex: 1;
            font-size: 15px;
            color: var(--dark);
        }

        .button-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
            flex-wrap: wrap;
            opacity: 0;
            animation: fadeInUp 0.5s ease-out 0.3s forwards;
        }

        button {
            padding: 14px 32px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            font-family: 'Noto Sans JP', sans-serif;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-next {
            background: var(--gradient-1);
            color: white;
            box-shadow: 0 4px 15px rgba(91, 44, 111, 0.3);
        }

        .btn-next:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(91, 44, 111, 0.4);
        }

        .btn-skip {
            background: linear-gradient(135deg, #6C757D 0%, #495057 100%);
            color: white;
        }

        .btn-skip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-reference {
            background: linear-gradient(135deg, #17A2B8 0%, #138496 100%);
            color: white;
        }

        .btn-reference:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
        }

        .btn-pause {
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            color: #333;
        }

        .btn-pause:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .start-screen, .complete-screen {
            padding: 60px 50px;
            text-align: center;
            background: 
                radial-gradient(ellipse at center top, rgba(91, 44, 111, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at center bottom, rgba(52, 152, 219, 0.03) 0%, transparent 50%);
        }

        .start-screen h2, .complete-screen h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 42px;
            color: var(--dark);
            margin-bottom: 25px;
            letter-spacing: 1px;
            position: relative;
            display: inline-block;
        }

        .start-screen h2::after, .complete-screen h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: var(--gradient-1);
            border-radius: 2px;
        }

        .start-screen p, .complete-screen p {
            font-size: 16px;
            color: #6C757D;
            line-height: 1.8;
            margin: 30px auto;
            max-width: 600px;
        }

        .btn-start {
            background: linear-gradient(135deg, #27AE60 0%, #229954 100%);
            color: white;
            font-size: 18px;
            padding: 18px 50px;
            margin-top: 20px;
            box-shadow: 0 6px 30px rgba(39, 174, 96, 0.3);
            transform: scale(1);
        }

        .btn-start:hover {
            transform: scale(1.05) translateY(-3px);
            box-shadow: 0 8px 40px rgba(39, 174, 96, 0.4);
        }

        .btn-new {
            background: linear-gradient(135deg, #3498DB 0%, #2980B9 100%);
            color: white;
            font-size: 16px;
            padding: 14px 40px;
            box-shadow: 0 4px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(52, 152, 219, 0.4);
        }

        .download-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .btn-download, .btn-upload {
            background: linear-gradient(135deg, #3498DB 0%, #2980B9 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-upload {
            background: linear-gradient(135deg, #9B59B6 0%, #8E44AD 100%);
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);
        }

        .btn-download:hover, .btn-upload:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(52, 152, 219, 0.4);
        }

        .btn-upload:hover {
            box-shadow: 0 6px 25px rgba(155, 89, 182, 0.4);
        }

        .btn-restart {
            background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%);
            color: white;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-restart:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(231, 76, 60, 0.4);
        }

        .paused-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .paused-modal {
            background: white;
            padding: 50px;
            border-radius: var(--radius-lg);
            text-align: center;
            animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        @keyframes scaleIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .paused-modal h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px;
            color: var(--dark);
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        .paused-modal .pause-emoji {
            font-size: 64px;
            margin-bottom: 20px;
            display: block;
            animation: pulse 2s ease-in-out infinite;
        }

        .btn-resume {
            background: linear-gradient(135deg, #27AE60 0%, #229954 100%);
            color: white;
            margin-top: 25px;
            padding: 16px 40px;
            box-shadow: 0 4px 20px rgba(39, 174, 96, 0.3);
        }

        .btn-resume:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 6px 30px rgba(39, 174, 96, 0.4);
        }

        .hint-text {
            font-size: 14px;
            color: var(--gray);
            font-style: italic;
            margin-top: 12px;
            opacity: 0.8;
        }

        .info-box {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-left: 4px solid #2196F3;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .info-box::before {
            content: 'ğŸ“Œ';
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            opacity: 0.5;
        }

        .info-box strong {
            color: #1565C0;
            display: block;
            margin-bottom: 10px;
            padding-left: 35px;
        }

        .result-info {
            font-size: 17px;
            margin-bottom: 25px;
            color: var(--dark);
            padding: 20px;
            background: linear-gradient(135deg, #F0F0F0 0%, #FAFAFA 100%);
            border-radius: var(--radius-sm);
            border: 1px solid #E0E0E0;
        }

        .result-info strong {
            color: var(--primary);
            font-weight: 700;
        }

        .patient-info-display {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: left;
        }

        .patient-info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .patient-info-row:last-child {
            border-bottom: none;
        }

        .patient-info-label {
            font-weight: 600;
            color: #495057;
        }

        .patient-info-value {
            color: #212529;
        }

        .patient-selector {
            margin: 20px 0;
        }

        .patient-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .patient-option:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateX(5px);
        }

        .patient-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #F3E5F5 0%, #FFFFFF 100%);
        }

        .change-summary {
            background: #fff9e6;
            border: 2px solid #ffeb99;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .change-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ffe680;
        }

        .change-item:last-child {
            border-bottom: none;
        }

        .change-field {
            font-weight: 600;
            color: #856404;
        }

        .change-values {
            text-align: right;
        }

        .old-value {
            color: #dc3545;
            text-decoration: line-through;
        }

        .new-value {
            color: #28a745;
            font-weight: 600;
        }

        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #e9ecef, transparent);
            margin: 30px 0;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 768px) {
            .container {
                border-radius: var(--radius);
            }
            
            .header h1 {
                font-size: 28px;
            }
            
            .question-text {
                font-size: 22px;
            }
            
            .question-container {
                padding: 30px;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            button {
                padding: 12px 24px;
                font-size: 14px;
            }
            
            .start-screen h2, .complete-screen h2 {
                font-size: 32px;
            }
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æœ€é©åŒ– */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="emoji">ğŸ’Š</span> è–¬å‰¤ç®¡ç†ã‚µãƒãƒªãƒ¼è‡ªå‹•ä½œæˆã‚·ã‚¹ãƒ†ãƒ </h1>
            <div class="security-notice">
                ğŸ”’ <strong>å®Œå…¨ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆå‡¦ç†</strong><br>
                ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å‡¦ç†ã•ã‚Œã€å¤–éƒ¨é€ä¿¡ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“
            </div>
        </div>

        <div id="startScreen" class="start-screen">
            <h2>è–¬å‰¤ç®¡ç†ã‚µãƒãƒªãƒ¼ï¼ˆç²¾ç¥ç§‘ç‰ˆï¼‰</h2>
            
            <div id="initialSection">
                <div class="info-box">
                    <strong>ãƒ‡ãƒ¼ã‚¿ç®¡ç†æ–¹æ³•ã‚’é¸æŠ</strong>
                    æ—¢å­˜ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯èª­ã¿è¾¼ã¿ã€<br>
                    ãªã„å ´åˆã¯æ–°è¦ä½œæˆã§ãã¾ã™ã€‚
                </div>
                
                <p style="margin-bottom: 30px;">
                    æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„
                </p>
                
                <input type="file" id="csvInitialUpload" accept=".csv" style="display: none;" onchange="handleInitialFileUpload(event)">
                
                <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn-upload" onclick="document.getElementById('csvInitialUpload').click()" style="padding: 18px 40px;">
                        ğŸ“‚ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
                    </button>
                    
                    <button class="btn-new" onclick="startNewEntry()" style="padding: 18px 40px;">
                        âœ¨ æ–°è¦ä½œæˆ
                    </button>
                </div>
            </div>
            
            <div id="patientSelectionSection" style="display: none;">
                <h3 style="font-size: 28px; margin: 30px 0 20px; color: #333;">æ‚£è€…æƒ…å ±ã®ç¢ºèª</h3>
                
                <div id="patientsList">
                    <!-- è¤‡æ•°æ‚£è€…ãŒã„ã‚‹å ´åˆã¯ã“ã“ã«ãƒªã‚¹ãƒˆè¡¨ç¤º -->
                </div>
                
                <div id="selectedPatientInfo" class="patient-info-display">
                    <!-- é¸æŠã•ã‚ŒãŸæ‚£è€…æƒ…å ±ã‚’ã“ã“ã«è¡¨ç¤º -->
                </div>
                
                <div class="info-box" style="margin: 25px 0;">
                    <strong>â±ï¸ è³ªå•å½¢å¼ã«ã¤ã„ã¦</strong>
                    ã“ã‚Œã‹ã‚‰ç´„50é …ç›®ã®è³ªå•ã‚’é †ç•ªã«è¡¨ç¤ºã—ã¾ã™ã€‚<br>
                    å„è³ªå•ã«ã¯<strong>30ç§’ã®å›ç­”æ™‚é–“</strong>ãŒã‚ã‚Šã¾ã™ã€‚<br>
                    æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹é …ç›®ã¯è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ã€‚
                </div>
                
                <button class="btn-start" onclick="startQuestionnaire()">
                    ã“ã®æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã§ç·¨é›†é–‹å§‹
                </button>
                
                <button class="btn-restart" onclick="resetToInitial()" style="margin-top: 15px; padding: 12px 30px;">
                    æœ€åˆã«æˆ»ã‚‹
                </button>
            </div>
        </div>

        <div id="questionScreen" style="display: none;">
            <div class="progress-container">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text">
                    <span id="questionNumber">è³ªå• 1 / 50</span>
                    <span id="categoryName">åŸºæœ¬æƒ…å ±</span>
                </div>
            </div>

            <div class="timer-container">
                <span class="timer-text" id="timerText">30</span>
                <div class="timer-bar">
                    <div id="timerFill" class="timer-fill" style="width: 100%"></div>
                </div>
            </div>

            <div class="question-container">
                <div class="question-category" id="questionCategory">åŸºæœ¬æƒ…å ±</div>
                <div class="question-text">
                    <span id="questionText">è³ªå•å†…å®¹</span>
                    <span id="changeIndicator" class="change-indicator" style="display: none;">å¤‰æ›´ã‚ã‚Š</span>
                </div>
                <div class="input-container" id="inputContainer"></div>
                <div class="hint-text" id="hintText"></div>
                <div class="button-container">
                    <button class="btn-skip" onclick="skipQuestion()">ã‚¹ã‚­ãƒƒãƒ—</button>
                    <button class="btn-reference" onclick="setReference()">ğŸ“ åˆ¥ç´™å‚ç…§</button>
                    <button class="btn-pause" onclick="pauseTimer()">ä¸€æ™‚åœæ­¢</button>
                    <button class="btn-next" onclick="nextQuestion()">æ¬¡ã¸ â†’</button>
                </div>
            </div>
        </div>

        <div id="completeScreen" style="display: none;">
            <div class="complete-screen">
                <h2>âœ… å…¥åŠ›å®Œäº†</h2>
                
                <div class="result-info" id="resultInfo">
                    <!-- æ‚£è€…æƒ…å ±ã‚µãƒãƒªãƒ¼ã‚’ã“ã“ã«è¡¨ç¤º -->
                </div>
                
                <div class="change-summary" id="changeSummary">
                    <h4 style="color: #856404; margin-bottom: 15px;">ğŸ“ å¤‰æ›´ã•ã‚ŒãŸé …ç›®</h4>
                    <div id="changesList">
                        <!-- å¤‰æ›´ãƒªã‚¹ãƒˆã‚’ã“ã“ã«è¡¨ç¤º -->
                    </div>
                </div>
                
                <p>
                    ã™ã¹ã¦ã®è³ªå•ã¸ã®å›ç­”ãŒå®Œäº†ã—ã¾ã—ãŸã€‚<br>
                    å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
                </p>
                
                <div class="download-buttons">
                    <button class="btn-download" onclick="downloadCSV()">
                        ğŸ“Š CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                    <button class="btn-download" onclick="downloadText()">
                        ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>
                
                <button class="btn-restart" onclick="location.reload()">
                    ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™
                </button>
            </div>
        </div>

        <div id="pausedOverlay" class="paused-overlay">
            <div class="paused-modal">
                <span class="pause-emoji">â¸ï¸</span>
                <h3>ä¸€æ™‚åœæ­¢ä¸­</h3>
                <p>æº–å‚™ãŒã§ããŸã‚‰ã€Œå†é–‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                <button class="btn-resume" onclick="resumeTimer()">å†é–‹ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
        const TIMER_SECONDS = 30;
        
        // å…¨è³ªå•ãƒ‡ãƒ¼ã‚¿ï¼ˆåŸºæœ¬æƒ…å ±ã‚’å«ã‚€ï¼‰
        const allQuestions = [
            // åŸºæœ¬æƒ…å ±
            { category: "åŸºæœ¬æƒ…å ±", field: "patientName", question: "æ‚£è€…æ°å", type: "text" },
            { category: "åŸºæœ¬æƒ…å ±", field: "patientId", question: "æ‚£è€…ID", type: "text" },
            { category: "åŸºæœ¬æƒ…å ±", field: "admissionDate", question: "å…¥é™¢æ—¥", type: "date" },
            { category: "åŸºæœ¬æƒ…å ±", field: "dischargeDate", question: "é€€é™¢æ—¥", type: "date" },
            { category: "åŸºæœ¬æƒ…å ±", field: "gender", question: "æ€§åˆ¥", type: "select", options: ["ç”·æ€§", "å¥³æ€§", "ãã®ä»–"] },
            { category: "åŸºæœ¬æƒ…å ±", field: "birthDate", question: "ç”Ÿå¹´æœˆæ—¥", type: "date" },
            { category: "åŸºæœ¬æƒ…å ±", field: "doctor", question: "æ‹…å½“åŒ»", type: "text" },
            { category: "åŸºæœ¬æƒ…å ±", field: "pharmacist", question: "æ‹…å½“è–¬å‰¤å¸«", type: "text" },
            { category: "åŸºæœ¬æƒ…å ±", field: "height", question: "èº«é•·(cm)", type: "number", hint: "ä¾‹: 165" },
            { category: "åŸºæœ¬æƒ…å ±", field: "weight", question: "ä½“é‡(kg)", type: "number", hint: "ä¾‹: 60" },
            { category: "åŸºæœ¬æƒ…å ±", field: "smoking", question: "å–«ç…™æ­´", type: "select", options: ["ãªã—", "ã‚ã‚Šï¼ˆç¾åœ¨ï¼‰", "ã‚ã‚Šï¼ˆéå»ï¼‰"] },
            { category: "åŸºæœ¬æƒ…å ±", field: "drinking", question: "é£²é…’æ­´", type: "select", options: ["ãªã—", "ã‚ã‚Šï¼ˆç¾åœ¨ï¼‰", "ã‚ã‚Šï¼ˆéå»ï¼‰"] },
            
            // ç—…æ­´æƒ…å ±
            { category: "ç—…æ­´æƒ…å ±", field: "mainDiagnosis", question: "ä¸»ç—…å", type: "text" },
            { category: "ç—…æ­´æƒ…å ±", field: "medicalHistory", question: "æ—¢å¾€æ­´", type: "textarea", hint: "è¤‡æ•°ã‚ã‚‹å ´åˆã¯æ”¹è¡Œã§åŒºåˆ‡ã£ã¦å…¥åŠ›" },
            { category: "ç—…æ­´æƒ…å ±", field: "admissionReason", question: "å…¥é™¢ç†ç”±", type: "select", options: ["ç—…çŠ¶æ‚ªåŒ–", "æ€ è–¬ã«ã‚ˆã‚‹ç—…çŠ¶æ‚ªåŒ–", "é€šé™¢ä¸­æ–­ã«ã‚ˆã‚‹ç—…çŠ¶æ‚ªåŒ–", "å‰¯ä½œç”¨", "åˆç™º", "ãã®ä»–"] },
            { category: "ç—…æ­´æƒ…å ±", field: "admissionReasonOther", question: "ãã®ä»–ã®å…¥é™¢ç†ç”±", type: "text", hint: "å‰å•ã§ã€Œãã®ä»–ã€ã‚’é¸æŠã—ãŸå ´åˆã«å…¥åŠ›" },
            
            // ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒ»å‰¯ä½œç”¨æ­´
            { category: "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±", field: "allergyHistory", question: "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æ­´", type: "select", options: ["ãªã—", "ã‚ã‚Š", "ç–‘ã„"] },
            { category: "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±", field: "allergyDetails", question: "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã®è©³ç´°", type: "text", hint: "è–¬å‰¤åã‚„ç—‡çŠ¶ã‚’å…¥åŠ›" },
            { category: "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±", field: "sideEffectHistory", question: "å‰¯ä½œç”¨æ­´", type: "select", options: ["ãªã—", "ã‚ã‚Š", "ç–‘ã„"] },
            { category: "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±", field: "sideEffectDetails", question: "å‰¯ä½œç”¨ã®è©³ç´°", type: "text", hint: "è–¬å‰¤åã‚„ç—‡çŠ¶ã‚’å…¥åŠ›" },
            
            // æœè–¬ç®¡ç†æƒ…å ±
            { category: "æœè–¬ç®¡ç†", field: "priorMedicationManager", question: "å…¥é™¢å‰ã®æœè–¬ç®¡ç†è€…", type: "select", options: ["æœ¬äººç®¡ç†", "å®¶æ—ç®¡ç†", "ãã®ä»–"] },
            { category: "æœè–¬ç®¡ç†", field: "priorManagementMethod", question: "å…¥é™¢å‰ã®ç®¡ç†æ–¹æ³•", type: "select", options: ["ãã®ã¾ã¾", "ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼", "ãƒœãƒƒã‚¯ã‚¹", "ãƒ•ã‚¡ã‚¤ãƒ«", "ãã®ä»–"] },
            { category: "æœè–¬ç®¡ç†", field: "postMedicationManager", question: "é€€é™¢å¾Œã®æœè–¬ç®¡ç†è€…", type: "select", options: ["æœ¬äºº", "å®¶æ—", "åŒ»ç™‚å¾“äº‹è€…", "ãã®ä»–"] },
            { category: "æœè–¬ç®¡ç†", field: "dischargeDestination", question: "é€€é™¢å…ˆ", type: "select", options: ["å½“é™¢", "ä»–é™¢", "è‡ªå®…", "æ–½è¨­"] },
            
            // å…¥é™¢æ™‚æŒå‚è–¬
            { category: "æŒå‚è–¬", field: "broughtMedications", question: "å…¥é™¢æ™‚æŒå‚è–¬", type: "select", options: ["ã‚ã‚Š", "ãªã—"] },
            { category: "æŒå‚è–¬", field: "prescribingInstitution", question: "å‡¦æ–¹åŒ»ç™‚æ©Ÿé–¢", type: "text", hint: "æŒå‚è–¬ãŒã‚ã‚‹å ´åˆ" },
            { category: "æŒå‚è–¬", field: "medicationInfoSource", question: "è–¬å‰¤æƒ…å ±ã®ç¢ºèªæ–¹æ³•", type: "checkbox", options: ["ãŠè–¬æ‰‹å¸³", "æ‰‹å¸³ã‚¢ãƒ—ãƒª", "ãƒã‚¤ãƒŠä¿é™ºè¨¼", "ç´¹ä»‹çŠ¶", "è–¬æƒ…"] },
            { category: "æŒå‚è–¬", field: "prescriptionDetails", question: "å‡¦æ–¹è–¬ã®è©³ç´°", type: "textarea", hint: "è–¬å‰¤åã€ç”¨æ³•ç”¨é‡ãªã©" },
            
            // æœè–¬çŠ¶æ³
            { category: "æœè–¬çŠ¶æ³", field: "priorAdherence", question: "å…¥é™¢å‰ã®æœè–¬çŠ¶æ³", type: "select", options: ["è‰¯å¥½", "é£²ã¿å¿˜ã‚Œ", "æ‹’è–¬å‚¾å‘", "ãã®ä»–"] },
            { category: "æœè–¬çŠ¶æ³", field: "hospitalAdherence", question: "å…¥é™¢ä¸­ã®æœè–¬çŠ¶æ³", type: "select", options: ["è‰¯å¥½", "é£²ã¿å¿˜ã‚Œ", "æ‹’è–¬å‚¾å‘", "ãã®ä»–"] },
            { category: "æœè–¬çŠ¶æ³", field: "administrationRoute", question: "è–¬å‰¤æŠ•ä¸æ–¹æ³•", type: "select", options: ["çµŒå£ï¼ˆæ™®é€šéŒ ï¼‰", "çµŒå£ï¼ˆç²‰ç •ï¼‰", "çµŒç®¡ï¼ˆç²‰ç •ï¼‰", "çµŒç®¡ï¼ˆç°¡æ˜“æ‡¸æ¿æ³•ï¼‰"] },
            { category: "æœè–¬çŠ¶æ³", field: "dispensingMethod", question: "å…¥é™¢ä¸­ã®èª¿å‰¤æ–¹æ³•", type: "select", options: ["æ—¥ä»˜ã‚ã‚Šä¸€åŒ…åŒ–", "æ—¥ä»˜ãªã—ä¸€åŒ…åŒ–", "ãã®ä»–"] },
            
            // æœè–¬ã‚¢ãƒ‰ãƒ’ã‚¢ãƒ©ãƒ³ã‚¹
            { category: "ã‚¢ãƒ‰ãƒ’ã‚¢ãƒ©ãƒ³ã‚¹", field: "refusalReason", question: "æ‹’è–¬ãƒ»æ€ è–¬ã®ç†ç”±", type: "checkbox", options: [
                "æ¯æ—¥è–¬ã‚’é£²ã‚€ã®ãŒé¢å€’",
                "è–¬ã‚’é£²ã‚€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒé›£ã—ã„",
                "äººå‰ã§è–¬ã‚’é£²ã‚€ã“ã¨ã«æŠµæŠ—",
                "å®¶æ—ã®æœè–¬ç¢ºèªã«æŠµæŠ—",
                "è–¬ã®é‡ã‚’è‡ªåˆ†ã§èª¿ç¯€",
                "è–¬ã‚’é£²ã‚€é‡ãŒå¤šã„",
                "è–¬ã‚’é£²ã‚€å›æ•°ãŒå¤šã„",
                "é£²ã¿é–“é•ãˆã¦ã—ã¾ã†",
                "å‰¯ä½œç”¨ãŒã‚ã‚‹",
                "åŠ¹æœã‚’æ„Ÿã˜ãªã„",
                "å†ç™ºã—ãªã„ã¨æ€ã†",
                "æ´»å‹•ã‚’æ§ãˆã‚‹å¿…è¦",
                "ç—…æ°—ã®èªè­˜ä¸è¶³"
            ]},
            { category: "ã‚¢ãƒ‰ãƒ’ã‚¢ãƒ©ãƒ³ã‚¹", field: "sideEffectTypes", question: "çµŒé¨“ã—ãŸå‰¯ä½œç”¨", type: "checkbox", options: [
                "å–‰ã®æ¸‡ã",
                "çœ æ°—",
                "ä¾¿ç§˜",
                "é ­ãŒã¼ãƒ¼ã£ã¨ã™ã‚‹",
                "æ‰‹ã®éœ‡ãˆ",
                "ä½“é‡å¢—åŠ ",
                "ç”Ÿç†ä¸é †",
                "ãã®ä»–"
            ]},
            
            // ç²¾ç¥ç§‘è–¬å‰¤
            { category: "ç²¾ç¥ç§‘è–¬å‰¤", field: "medicationChanges", question: "è–¬å‰¤å¤‰æ›´ã®æœ‰ç„¡", type: "select", options: ["ã‚ã‚Š", "ãªã—"] },
            { category: "ç²¾ç¥ç§‘è–¬å‰¤", field: "changeType1", question: "å¤‰æ›´å†…å®¹1", type: "select", options: ["é–‹å§‹", "å¢—é‡", "æ¸›é‡", "ä¸­æ­¢", "å¤‰æ›´", "ãªã—"] },
            { category: "ç²¾ç¥ç§‘è–¬å‰¤", field: "changeDrug1", question: "å¤‰æ›´è–¬å‰¤å1", type: "text", hint: "å¤‰æ›´ãŒã‚ã£ãŸå ´åˆ" },
            { category: "ç²¾ç¥ç§‘è–¬å‰¤", field: "changeReason1", question: "å¤‰æ›´ç†ç”±1", type: "select", options: ["åŠ¹æœä¸ååˆ†", "å‰¯ä½œç”¨", "æ‚£è€…å¸Œæœ›", "æ‹’è–¬", "ãã®ä»–"] },
            { category: "ç²¾ç¥ç§‘è–¬å‰¤", field: "sustainedInjection", question: "æŒåŠ¹æ€§æ³¨å°„å‰¤ã®ä½¿ç”¨", type: "select", options: ["ã‚ã‚Š", "ãªã—"] },
            { category: "ç²¾ç¥ç§‘è–¬å‰¤", field: "injectionDetails", question: "æŒåŠ¹æ€§æ³¨å°„å‰¤ã®è©³ç´°", type: "text", hint: "è–¬å‰¤åã€ç”¨é‡ã€æœ€çµ‚æŠ•ä¸æ—¥ãªã©" },
            
            // DIEPSSè©•ä¾¡
            { category: "DIEPSSè©•ä¾¡", field: "diepssGait", question: "DIEPSSè©•ä¾¡ï¼šæ­©è¡Œ", type: "select", options: ["0", "1", "2", "3", "4"] },
            { category: "DIEPSSè©•ä¾¡", field: "diepssBradykinesia", question: "DIEPSSè©•ä¾¡ï¼šå‹•ä½œç·©æ…¢", type: "select", options: ["0", "1", "2", "3", "4"] },
            { category: "DIEPSSè©•ä¾¡", field: "diepssSialorrhea", question: "DIEPSSè©•ä¾¡ï¼šæµæ¶", type: "select", options: ["0", "1", "2", "3", "4"] },
            { category: "DIEPSSè©•ä¾¡", field: "diepssRigidity", question: "DIEPSSè©•ä¾¡ï¼šç­‹å¼·å‰›", type: "select", options: ["0", "1", "2", "3", "4"] },
            { category: "DIEPSSè©•ä¾¡", field: "diepssTremor", question: "DIEPSSè©•ä¾¡ï¼šæŒ¯æˆ¦", type: "select", options: ["0", "1", "2", "3", "4"] },
            { category: "DIEPSSè©•ä¾¡", field: "diepssAkathisia", question: "DIEPSSè©•ä¾¡ï¼šã‚¢ã‚«ã‚·ã‚¸ã‚¢", type: "select", options: ["0", "1", "2", "3", "4"] },
            { category: "DIEPSSè©•ä¾¡", field: "diepssDystonia", question: "DIEPSSè©•ä¾¡ï¼šã‚¸ã‚¹ãƒˆãƒ‹ã‚¢", type: "select", options: ["0", "1", "2", "3", "4"] },
            { category: "DIEPSSè©•ä¾¡", field: "diepssDyskinesia", question: "DIEPSSè©•ä¾¡ï¼šã‚¸ã‚¹ã‚­ãƒã‚¸ã‚¢", type: "select", options: ["0", "1", "2", "3", "4"] },
            
            // æ¤œæŸ»å€¤
            { category: "æ¤œæŸ»å€¤", field: "ast", question: "ASTå€¤ (IU/L)", type: "number", hint: "æœ€æ–°ã®æ¤œæŸ»å€¤" },
            { category: "æ¤œæŸ»å€¤", field: "alt", question: "ALTå€¤ (IU/L)", type: "number", hint: "æœ€æ–°ã®æ¤œæŸ»å€¤" },
            { category: "æ¤œæŸ»å€¤", field: "ggt", question: "Î³-GTPå€¤ (IU/L)", type: "number", hint: "æœ€æ–°ã®æ¤œæŸ»å€¤" },
            { category: "æ¤œæŸ»å€¤", field: "scr", question: "SCrå€¤ (mg/dl)", type: "number", hint: "æœ€æ–°ã®æ¤œæŸ»å€¤" },
            { category: "æ¤œæŸ»å€¤", field: "egfr", question: "eGFRå€¤ (mL/min/1.73m2)", type: "number", hint: "æœ€æ–°ã®æ¤œæŸ»å€¤" },
            { category: "æ¤œæŸ»å€¤", field: "regularTestDrugs", question: "å®šæœŸæ¤œæŸ»ãŒå¿…è¦ãªè–¬å‰¤", type: "text", hint: "è–¬å‰¤åã¨æœ€çµ‚æ¤œæŸ»æ—¥" },
            
            // çµŒéãƒ»ç”³ã—é€ã‚Š
            { category: "çµŒéãƒ»ç”³ã—é€ã‚Š", field: "treatmentProgress", question: "å…¥é™¢ä¸­ã®è–¬ç‰©æ²»ç™‚çµŒé", type: "textarea", hint: "é‡è¦ãªçµŒéã‚’è¨˜å…¥" },
            { category: "çµŒéãƒ»ç”³ã—é€ã‚Š", field: "patientProblems", question: "æ‚£è€…ã®å•é¡Œç‚¹", type: "textarea", hint: "æœè–¬ã«é–¢ã™ã‚‹å•é¡Œãªã©" },
            { category: "çµŒéãƒ»ç”³ã—é€ã‚Š", field: "interventions", question: "æœè–¬æŒ‡å°ãƒ»ä»‹å…¥ã®è¦ç‚¹", type: "textarea" },
            { category: "çµŒéãƒ»ç”³ã—é€ã‚Š", field: "postDischargeProblems", question: "é€€é™¢å¾Œã®å•é¡Œç‚¹", type: "textarea" },
            { category: "çµŒéãƒ»ç”³ã—é€ã‚Š", field: "handoverNotes", question: "ä»–åŒ»ç™‚æ©Ÿé–¢ã¸ã®ç”³ã—é€ã‚Šäº‹é …", type: "textarea", hint: "é‡è¦ãªæ³¨æ„äº‹é …ãªã©" }
        ];

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentQuestionIndex = 0;
        let originalAnswers = {}; // CSVã‹ã‚‰èª­ã¿è¾¼ã‚“ã å…ƒãƒ‡ãƒ¼ã‚¿
        let answers = {}; // ç·¨é›†ä¸­ã®ãƒ‡ãƒ¼ã‚¿
        let changes = {}; // å¤‰æ›´å±¥æ­´
        let timer = null;
        let timeRemaining = TIMER_SECONDS;
        let isPaused = false;
        let questionFieldMap = {};
        let selectedPatientIndex = 0;
        let patientsData = [];

        // åˆæœŸåŒ–
        function init() {
            // questionFieldMapã®æ§‹ç¯‰
            allQuestions.forEach(q => {
                questionFieldMap[q.question] = q.field;
            });
        }

        // æ–°è¦ä½œæˆé–‹å§‹
        function startNewEntry() {
            // ç©ºã®ãƒ‡ãƒ¼ã‚¿ã§é–‹å§‹
            originalAnswers = {};
            answers = {};
            changes = {};
            
            // æ‚£è€…é¸æŠç”»é¢ã‚’è¡¨ç¤º
            document.getElementById('initialSection').style.display = 'none';
            document.getElementById('patientSelectionSection').style.display = 'block';
            
            // æ–°è¦ä½œæˆã®æ¡ˆå†…ã‚’è¡¨ç¤º
            document.getElementById('selectedPatientInfo').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <p style="font-size: 18px; color: #495057; margin-bottom: 15px;">
                        <strong>æ–°è¦æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™</strong>
                    </p>
                    <p style="color: #6c757d;">
                        åŸºæœ¬æƒ…å ±ã‹ã‚‰é †ç•ªã«å…¥åŠ›ã—ã¦ã„ãã¾ã™
                    </p>
                </div>
            `;
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã®åˆæœŸèª­ã¿è¾¼ã¿
        function handleInitialFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                try {
                    parseCSVData(csvText);
                    showPatientSelection();
                } catch (error) {
                    console.error("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", error);
                    alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }
            };
            reader.readAsText(file, 'UTF-8');
            document.getElementById('csvInitialUpload').value = '';
        }

        // CSVãƒ‘ãƒ¼ã‚¹å‡¦ç†
        function parseCSVData(csvText) {
            // BOMã®é™¤å»
            if (csvText.charCodeAt(0) === 0xFEFF) {
                csvText = csvText.substring(1);
            }

            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length <= 1) return;

            // ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¤‰æ›
            const tempAnswers = {};
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;

                // CSVãƒ‘ãƒ¼ã‚¹
                const parts = parseCSVLine(line);
                const questionText = parts[0];
                const answerValue = parts[1] || '';

                const fieldName = questionFieldMap[questionText];
                if (fieldName) {
                    tempAnswers[fieldName] = answerValue;
                }
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            originalAnswers = { ...tempAnswers };
            answers = { ...tempAnswers };
            changes = {};
        }

        // CSVè¡Œã®ãƒ‘ãƒ¼ã‚¹
        function parseCSVLine(line) {
            const parts = [];
            let inQuotes = false;
            let start = 0;
            
            for (let j = 0; j < line.length; j++) {
                if (line[j] === '"') {
                    inQuotes = !inQuotes;
                } else if (line[j] === ',' && !inQuotes) {
                    parts.push(line.substring(start, j).trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                    start = j + 1;
                }
            }
            parts.push(line.substring(start).trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
            
            return parts;
        }

        // æ‚£è€…é¸æŠç”»é¢ã®è¡¨ç¤º
        function showPatientSelection() {
            document.getElementById('initialSection').style.display = 'none';
            document.getElementById('patientSelectionSection').style.display = 'block';
            
            // æ‚£è€…æƒ…å ±ã®è¡¨ç¤º
            const patientInfo = document.getElementById('selectedPatientInfo');
            let html = '<h4 style="margin-bottom: 15px; color: #333;">èª­ã¿è¾¼ã¾ã‚ŒãŸæ‚£è€…æƒ…å ±</h4>';
            
            // åŸºæœ¬æƒ…å ±ã‚’è¡¨ç¤º
            const basicInfo = [
                { field: 'patientName', label: 'æ‚£è€…æ°å' },
                { field: 'patientId', label: 'æ‚£è€…ID' },
                { field: 'gender', label: 'æ€§åˆ¥' },
                { field: 'birthDate', label: 'ç”Ÿå¹´æœˆæ—¥' },
                { field: 'admissionDate', label: 'å…¥é™¢æ—¥' },
                { field: 'dischargeDate', label: 'é€€é™¢æ—¥' },
                { field: 'doctor', label: 'æ‹…å½“åŒ»' },
                { field: 'pharmacist', label: 'æ‹…å½“è–¬å‰¤å¸«' }
            ];
            
            basicInfo.forEach(info => {
                const value = answers[info.field] || 'æœªå…¥åŠ›';
                html += `
                    <div class="patient-info-row">
                        <span class="patient-info-label">${info.label}:</span>
                        <span class="patient-info-value">${value}</span>
                    </div>
                `;
            });
            
            // ãƒ‡ãƒ¼ã‚¿å…¥åŠ›çŠ¶æ³ã®ã‚µãƒãƒªãƒ¼
            const totalQuestions = allQuestions.length;
            const answeredQuestions = Object.keys(answers).filter(key => answers[key] && answers[key] !== '').length;
            const completionRate = Math.round((answeredQuestions / totalQuestions) * 100);
            
            html += `
                <div class="divider"></div>
                <div style="text-align: center; padding: 15px 0;">
                    <p style="font-size: 18px; color: #495057;">
                        å…¥åŠ›æ¸ˆã¿é …ç›®: <strong style="color: #28a745;">${answeredQuestions} / ${totalQuestions}</strong>
                        <span style="margin-left: 15px;">å®Œæˆåº¦: <strong>${completionRate}%</strong></span>
                    </p>
                </div>
            `;
            
            patientInfo.innerHTML = html;
        }

        // æœ€åˆã«æˆ»ã‚‹
        function resetToInitial() {
            document.getElementById('patientSelectionSection').style.display = 'none';
            document.getElementById('initialSection').style.display = 'block';
            originalAnswers = {};
            answers = {};
            changes = {};
        }

        // è³ªå•é–‹å§‹
        function startQuestionnaire() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('questionScreen').style.display = 'block';
            showQuestion(0);
        }

        // è³ªå•è¡¨ç¤º
        function showQuestion(index) {
            if (index >= allQuestions.length) {
                completeQuestionnaire();
                return;
            }

            const q = allQuestions[index];
            currentQuestionIndex = index;

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªã‚»ãƒƒãƒˆ
            const elements = [
                document.getElementById('questionCategory'),
                document.getElementById('questionText').parentElement,
                document.getElementById('inputContainer'),
                document.querySelector('.button-container')
            ];
            
            elements.forEach(el => {
                if (el) {
                    el.style.animation = 'none';
                    el.offsetHeight;
                    el.style.animation = null;
                }
            });

            // é€²æ—æ›´æ–°
            const progress = ((index + 1) / allQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('questionNumber').textContent = `è³ªå• ${index + 1} / ${allQuestions.length}`;
            document.getElementById('categoryName').textContent = q.category;
            
            // è³ªå•è¡¨ç¤º
            document.getElementById('questionCategory').textContent = q.category;
            document.getElementById('questionText').textContent = q.question;
            document.getElementById('hintText').textContent = q.hint || '';

            // å¤‰æ›´ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
            const changeIndicator = document.getElementById('changeIndicator');
            if (changes[q.field] !== undefined && originalAnswers[q.field] !== answers[q.field]) {
                changeIndicator.style.display = 'inline-block';
            } else {
                changeIndicator.style.display = 'none';
            }

            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”Ÿæˆ
            const inputContainer = document.getElementById('inputContainer');
            inputContainer.innerHTML = '';

            // æ—¢å­˜ã®å›ç­”å€¤ã‚’å–å¾—
            const currentValue = answers[q.field] || '';

            if (q.type === 'text' || q.type === 'number' || q.type === 'date') {
                const input = document.createElement('input');
                input.type = q.type;
                input.id = 'currentInput';
                input.value = currentValue;
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        nextQuestion();
                    }
                });
                inputContainer.appendChild(input);
                setTimeout(() => input.focus(), 100);
            } else if (q.type === 'textarea') {
                const textarea = document.createElement('textarea');
                textarea.id = 'currentInput';
                textarea.value = currentValue;
                textarea.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        nextQuestion();
                    }
                });
                inputContainer.appendChild(textarea);
                setTimeout(() => textarea.focus(), 100);
            } else if (q.type === 'select') {
                const select = document.createElement('select');
                select.id = 'currentInput';
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'é¸æŠã—ã¦ãã ã•ã„';
                select.appendChild(defaultOption);
                
                q.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    if (currentValue === opt) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                inputContainer.appendChild(select);
                setTimeout(() => select.focus(), 100);
            } else if (q.type === 'checkbox') {
                const checkboxGroup = document.createElement('div');
                checkboxGroup.className = 'checkbox-group';
                
                const currentValues = currentValue ? currentValue.split(',') : [];
                
                q.options.forEach((opt, i) => {
                    const item = document.createElement('div');
                    item.className = 'checkbox-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `checkbox_${i}`;
                    checkbox.value = opt;
                    checkbox.checked = currentValues.includes(opt);
                    
                    const label = document.createElement('label');
                    label.htmlFor = `checkbox_${i}`;
                    label.textContent = opt;
                    
                    item.appendChild(checkbox);
                    item.appendChild(label);
                    checkboxGroup.appendChild(item);
                });
                
                inputContainer.appendChild(checkboxGroup);
            }

            // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            startTimer();
        }

        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        function startTimer() {
            timeRemaining = TIMER_SECONDS;
            isPaused = false;
            updateTimerDisplay();
            
            if (timer) clearInterval(timer);
            
            timer = setInterval(() => {
                if (!isPaused) {
                    timeRemaining--;
                    updateTimerDisplay();
                    
                    if (timeRemaining <= 0) {
                        clearInterval(timer);
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºæ›´æ–°
        function updateTimerDisplay() {
            document.getElementById('timerText').textContent = timeRemaining;
            const percentage = (timeRemaining / TIMER_SECONDS) * 100;
            document.getElementById('timerFill').style.width = percentage + '%';
            document.getElementById('timerFill').style.transition = isPaused ? 'none' : 'width 1s linear';
        }

        // ä¸€æ™‚åœæ­¢
        function pauseTimer() {
            isPaused = true;
            clearInterval(timer);
            document.getElementById('pausedOverlay').style.display = 'flex';
        }

        // å†é–‹
        function resumeTimer() {
            document.getElementById('pausedOverlay').style.display = 'none';
            isPaused = false;
            
            timer = setInterval(() => {
                if (!isPaused) {
                    timeRemaining--;
                    updateTimerDisplay();
                    
                    if (timeRemaining <= 0) {
                        clearInterval(timer);
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        // æ¬¡ã®è³ªå•ã¸
        function nextQuestion() {
            saveCurrentAnswer();
            clearInterval(timer);
            showQuestion(currentQuestionIndex + 1);
        }

        // ã‚¹ã‚­ãƒƒãƒ—
        function skipQuestion() {
            clearInterval(timer);
            showQuestion(currentQuestionIndex + 1);
        }

        // åˆ¥ç´™å‚ç…§ã‚’è¨­å®š
        function setReference() {
            const q = allQuestions[currentQuestionIndex];
            const oldValue = answers[q.field];
            answers[q.field] = 'åˆ¥ç´™å‚ç…§';
            
            // å¤‰æ›´ã‚’è¨˜éŒ²
            if (originalAnswers[q.field] !== 'åˆ¥ç´™å‚ç…§') {
                changes[q.field] = {
                    old: originalAnswers[q.field] || 'æœªå…¥åŠ›',
                    new: 'åˆ¥ç´™å‚ç…§'
                };
            }
            
            clearInterval(timer);
            showQuestion(currentQuestionIndex + 1);
        }

        // ç¾åœ¨ã®å›ç­”ã‚’ä¿å­˜
        function saveCurrentAnswer() {
            const q = allQuestions[currentQuestionIndex];
            let newValue;
            
            if (q.type === 'checkbox') {
                const checkboxes = document.querySelectorAll('#inputContainer input[type="checkbox"]:checked');
                const values = Array.from(checkboxes).map(cb => cb.value);
                newValue = values.join(',');
            } else {
                const input = document.getElementById('currentInput');
                if (input) {
                    newValue = input.value;
                }
            }
            
            // å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿è¨˜éŒ²
            if (newValue !== undefined) {
                const oldValue = answers[q.field];
                answers[q.field] = newValue;
                
                // å…ƒãƒ‡ãƒ¼ã‚¿ã¨ç•°ãªã‚‹å ´åˆã¯å¤‰æ›´ã‚’è¨˜éŒ²
                if (originalAnswers[q.field] !== newValue) {
                    changes[q.field] = {
                        old: originalAnswers[q.field] || 'æœªå…¥åŠ›',
                        new: newValue || 'æœªå…¥åŠ›'
                    };
                } else {
                    // å…ƒãƒ‡ãƒ¼ã‚¿ã¨åŒã˜å€¤ã«æˆ»ã£ãŸå ´åˆã¯å¤‰æ›´ã‚’å‰Šé™¤
                    delete changes[q.field];
                }
            }
        }

        // å®Œäº†å‡¦ç†
        function completeQuestionnaire() {
            clearInterval(timer);
            document.getElementById('questionScreen').style.display = 'none';
            document.getElementById('completeScreen').style.display = 'block';
            
            // æ‚£è€…æƒ…å ±ã‚µãƒãƒªãƒ¼
            const resultInfo = document.getElementById('resultInfo');
            const patientName = answers.patientName || 'æœªå…¥åŠ›';
            const patientId = answers.patientId || 'æœªå…¥åŠ›';
            
            resultInfo.innerHTML = `
                <strong>æ‚£è€…æƒ…å ±:</strong> ${patientName} (ID: ${patientId})<br>
                <strong>å…¥é™¢æ—¥:</strong> ${answers.admissionDate || 'æœªå…¥åŠ›'} ï½ 
                <strong>é€€é™¢æ—¥:</strong> ${answers.dischargeDate || 'æœªå…¥åŠ›'}
            `;
            
            // å¤‰æ›´ã‚µãƒãƒªãƒ¼ã®è¡¨ç¤º
            const changesList = document.getElementById('changesList');
            if (Object.keys(changes).length > 0) {
                let changesHtml = '';
                for (const field in changes) {
                    const q = allQuestions.find(q => q.field === field);
                    if (q) {
                        changesHtml += `
                            <div class="change-item">
                                <span class="change-field">${q.question}</span>
                                <div class="change-values">
                                    <span class="old-value">${changes[field].old}</span>
                                    â†’ 
                                    <span class="new-value">${changes[field].new}</span>
                                </div>
                            </div>
                        `;
                    }
                }
                changesList.innerHTML = changesHtml;
                document.getElementById('changeSummary').style.display = 'block';
            } else {
                document.getElementById('changeSummary').style.display = 'none';
            }
        }

        // CSVç”Ÿæˆ
        function generateCSV() {
            const headers = ['é …ç›®å', 'å›ç­”'];
            const rows = [headers];
            
            allQuestions.forEach(q => {
                const answer = answers[q.field] || 'æœªå…¥åŠ›';
                rows.push([q.question, answer]);
            });
            
            // BOMä»˜ãUTF-8
            const BOM = '\uFEFF';
            const csvContent = BOM + rows.map(row => 
                row.map(cell => {
                    if (typeof cell === 'string' && (cell.includes(',') || cell.includes('"') || cell.includes('\n'))) {
                        return '"' + cell.replace(/"/g, '""') + '"';
                    }
                    return cell;
                }).join(',')
            ).join('\n');
            
            return csvContent;
        }

        // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadCSV() {
            const csv = generateCSV();
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const patientName = answers.patientName || 'æ–°è¦';
            const date = new Date().toISOString().split('T')[0];
            a.download = `è–¬å‰¤ç®¡ç†ã‚µãƒãƒªãƒ¼_${patientName}_${date}.csv`;
            
            a.click();
            URL.revokeObjectURL(url);
        }

        // ãƒ†ã‚­ã‚¹ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadText() {
            let text = 'è–¬å‰¤ç®¡ç†ã‚µãƒãƒªãƒ¼ï¼ˆç²¾ç¥ç§‘ç‰ˆï¼‰\n';
            text += '=' + '='.repeat(50) + '\n\n';
            text += `ä½œæˆæ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}\n\n`;
            
            // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«æ•´ç†
            let currentCategory = '';
            allQuestions.forEach(q => {
                if (currentCategory !== q.category) {
                    currentCategory = q.category;
                    text += '\nã€' + currentCategory + 'ã€‘\n';
                    text += '-'.repeat(40) + '\n';
                }
                
                let answer = answers[q.field] || 'æœªå…¥åŠ›';
                
                // å¤‰æ›´ãŒã‚ã‚‹é …ç›®ã«ã¯å°ã‚’ã¤ã‘ã‚‹
                const prefix = changes[q.field] ? '[å¤‰æ›´] ' : '';
                
                if (q.type === 'textarea' && answer && answer.includes('\n')) {
                    answer = '\n' + answer.split('\n').map(line => '  ' + line.trim()).join('\n');
                }
                
                text += `${prefix}${q.question}: ${answer}\n`;
            });
            
            // å¤‰æ›´å±¥æ­´ã‚’è¿½åŠ 
            if (Object.keys(changes).length > 0) {
                text += '\n\nã€å¤‰æ›´å±¥æ­´ã€‘\n';
                text += '=' + '='.repeat(25) + '\n';
                for (const field in changes) {
                    const q = allQuestions.find(q => q.field === field);
                    if (q) {
                        text += `${q.question}: ${changes[field].old} â†’ ${changes[field].new}\n`;
                    }
                }
            }
            
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const patientName = answers.patientName || 'æ–°è¦';
            const date = new Date().toISOString().split('T')[0];
            a.download = `è–¬å‰¤ç®¡ç†ã‚µãƒãƒªãƒ¼_${patientName}_${date}.txt`;
            
            a.click();
            URL.revokeObjectURL(url);
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('questionScreen').style.display !== 'none') {
                if (e.key === 'Escape') {
                    pauseTimer();
                } else if (e.key === ' ' && isPaused) {
                    e.preventDefault();
                    resumeTimer();
                }
            }
        });

        // ãƒšãƒ¼ã‚¸é›¢è„±è­¦å‘Š
        window.addEventListener('beforeunload', function (e) {
            if (Object.keys(answers).length > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();
    </script>
</body>
</html>
